<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Code Complexity Analyzer (Mock Sonar)</title>
<link rel="preconnect" href="https://unpkg.com">
<style>
  :root { --bg:#0b1020; --panel:#121a33; --ink:#e8edf6; --muted:#a9b3c7; --accent:#6aa7ff; --bad:#ff6b6b; --warn:#ffbe55; --ok:#3ddc97; }
  body { margin:0; font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Noto Sans", Arial, sans-serif; background:var(--bg); color:var(--ink); }
  header { padding:16px 20px; border-bottom:1px solid #1e2a52; display:flex; gap:12px; align-items:center; }
  header h1 { font-size:16px; margin:0; letter-spacing:.3px; }
  header .tag { background:#1b2550; border:1px solid #2b3c7b; padding:4px 8px; border-radius:999px; color:#cfe0ff; font-size:12px; }
  main { padding:16px; max-width:1200px; margin:0 auto; }
  .row { display:grid; gap:12px; }
  @media (min-width: 1000px) { .row { grid-template-columns: 1.1fr .9fr; } }
  .card { background:var(--panel); border:1px solid #1d2b57; border-radius:14px; padding:14px; }
  .card h2, .card h3 { margin:0 0 10px 0; font-size:14px; color:#cfe0ff; letter-spacing:.2px; }
  .files { display:flex; flex-direction:column; gap:10px; }
  .file { border:1px dashed #2a3870; border-radius:12px; padding:10px; background:#0c1430; }
  .file header { display:flex; gap:8px; align-items:center; padding:0; border:none; }
  .file input[name="filename"] { flex:0 0 180px; background:#0a1130; color:var(--ink); border:1px solid #263776; padding:6px 8px; border-radius:8px; }
  .file button { margin-left:auto; background:#172459; color:#cfe0ff; border:1px solid #2b3c7b; border-radius:8px; padding:6px 10px; cursor:pointer; }
  textarea { width:100%; min-height:160px; resize:vertical; background:#0a1130; color:var(--ink); border:1px solid #263776; border-radius:8px; padding:8px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
  .actions { display:flex; gap:10px; }
  .btn { background:linear-gradient(180deg, #2956d1, #1c3da6); border:1px solid #274bb2; color:white; padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:600; }
  .btn.secondary { background:#172459; border-color:#2b3c7b; color:#cfe0ff; }
  .grid { display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; }
  .stat { background:#0c1430; border:1px solid #24346b; border-radius:12px; padding:12px; text-align:center; }
  .stat .label { color:var(--muted); font-size:12px; }
  .stat .value { font-size:18px; font-weight:700; margin-top:6px; }
  table { width:100%; border-collapse:collapse; }
  th, td { padding:8px; border-bottom:1px solid #1e2a52; text-align:left; }
  th { color:#cfe0ff; font-weight:600; font-size:12px; }
  .pill { padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid #2b3c7b; background:#142051; color:#cfe0ff; }
  .pill.bad { border-color:#5a1e2a; background:#2a0d17; color:#ffc7c7; }
  .pill.warn { border-color:#5a4a1e; background:#2a220d; color:#ffe2a6; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
  .small { font-size:12px; color:var(--muted); }
  .split { display:grid; gap:12px; grid-template-columns: 1fr; }
  @media (min-width: 1000px) { .split { grid-template-columns: 1fr 1fr; } }
  .legend { display:flex; gap:8px; align-items:center; }
  .legend span { font-size:12px; color:var(--muted); }
  .badge { width:10px; height:10px; border-radius:2px; display:inline-block; background:#6aa7ff; }
  .badge.ext { background:#3ddc97; }
  details { background:#0c1430; border:1px solid #24346b; border-radius:12px; padding:8px 10px; }
  summary { cursor:pointer; color:#cfe0ff; }
  .error { color:#ffb0b0; }
  footer { padding:10px 16px 30px; color:#9fb2df; }
</style>
</head>
<body>
<header>
  <h1>Code Complexity Analyzer — mock SonarQube</h1>
  <span class="tag">Browser-only • JS/ESM</span>
</header>

<main>
  <div class="row">
    <section class="card">
      <h2>Project Files</h2>
      <div class="files" id="files"></div>
      <div class="actions" style="margin-top:10px;">
        <button class="btn secondary" id="addFile">+ Add file</button>
        <button class="btn" id="analyze">Analyze</button>
      </div>
      <p class="small" style="margin-top:8px;">Tip: You can paste multiple modules. Imports like <span class="mono">import x from './utils.js'</span> or <span class="mono">require('./utils')</span> get graphed.</p>
    </section>

    <section class="card">
      <h2>Summary</h2>
      <div class="grid" id="stats">
        <div class="stat"><div class="label">Files</div><div class="value" id="s_files">–</div></div>
        <div class="stat"><div class="label">Functions</div><div class="value" id="s_funcs">–</div></div>
        <div class="stat"><div class="label">Avg CC</div><div class="value" id="s_avgcc">–</div></div>
        <div class="stat"><div class="label">Max CC</div><div class="value" id="s_maxcc">–</div></div>
      </div>
      <div style="margin-top:10px">
        <span class="pill" id="grade">Score: –</span>
        <span class="small">Mock maintainability score (0–100)</span>
      </div>
      <div id="errors" style="margin-top:10px"></div>
    </section>
  </div>

  <div class="card" style="margin-top:12px;">
    <h3>Functions by Cyclomatic Complexity</h3>
    <table id="fnTable">
      <thead><tr>
        <th>Function</th><th>File</th><th>LOC</th><th>Params</th><th>CC</th><th>Notes</th>
      </tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="split" style="margin-top:12px;">
    <section class="card">
      <h3>Dependency Graph</h3>
      <div class="legend" style="margin-bottom:8px">
        <span class="badge"></span><span>Project file</span>
        <span class="badge ext"></span><span>External module</span>
      </div>
      <svg id="graph" width="100%" height="420"></svg>
    </section>
    <section class="card">
      <h3>AST Preview</h3>
      <p class="small">Select a file to preview a trimmed AST (depth ≤ 3).</p>
      <select id="astSelect"></select>
      <pre id="astOut" class="mono" style="white-space:pre-wrap; margin-top:8px; max-height:360px; overflow:auto;"></pre>
    </section>
  </div>
</main>

<footer>
  <div class="small">Mock tool: metrics are approximate. For demo/teaching only.</div>
</footer>

<!-- deps -->
<script src="https://unpkg.com/esprima@4.0.1/dist/esprima.min.js"></script>
<script src="https://unpkg.com/d3@7.9.0/dist/d3.min.js"></script>

<script>
/* ---------- Small utilities ---------- */
const $ = (sel, el=document) => el.querySelector(sel);
const el = (tag, attrs={}, children=[]) => {
  const n = document.createElement(tag);
  for (const [k,v] of Object.entries(attrs)) {
    if (k === "class") n.className = v;
    else if (k === "text") n.textContent = v;
    else n.setAttribute(k, v);
  }
  for (const c of (Array.isArray(children) ? children : [children])) {
    if (c) n.appendChild(typeof c === "string" ? document.createTextNode(c) : c);
  }
  return n;
};
const stripExt = (p) => p.replace(/\.(m?js|cjs|jsx|ts|tsx)$/i,'');
const norm = (p) => stripExt(p).replace(/^.\//,'').replace(/\\/g,'/');

/* ---------- UI: files list ---------- */
const filesEl = $("#files");
const exampleMain = `import { add, max } from './utils.js';

export function score(items) {
  let s = 0;
  for (const it of items) {
    if (it.crit && (it.value > 10 || it.flag)) {
      s += add(it.value, 1);
    } else if (it.value > 5) {
      s += it.value;
    } else {
      s += 1;
    }
  }
  return max(s, 0);
}

const risky = (n) => {
  while (n > 0) {
    try { n = n - 1 }
    catch (e) { n = 0 }
  }
  return n > 5 ? 5 : n;
};`;

const exampleUtils = `export const add = (a,b) => a + b;
export function max(a,b) {
  switch (true) {
    case a > b: return a;
    case b > a: return b;
    default: return a;
  }
}
module.exports = { legacy: function(x){ return x && x.y ? x.y : null } }`;

function addFileUI(name, code) {
  const wrap = el("div", { class:"file" });
  const head = el("header");
  const input = el("input", { name:"filename", value:name || "main.js", placeholder:"filename.js" });
  const del = el("button", { type:"button" }, "Remove");
  del.onclick = () => wrap.remove();
  head.append(input, el("span", { class:"small", style:"margin-left:6px" }, "JavaScript"), del);
  const ta = el("textarea", {}, code || "");
  wrap.append(head, ta);
  filesEl.appendChild(wrap);
  return wrap;
}

$("#addFile").onclick = () => addFileUI("", "");
function getFiles() {
  return [...filesEl.querySelectorAll(".file")].map(f => ({
    name: f.querySelector('input[name="filename"]').value.trim() || "untitled.js",
    code: f.querySelector("textarea").value
  }));
}

/* ---------- AST + metrics ---------- */
function parseFile(file) {
  try {
    const ast = esprima.parseModule(file.code, { range:true, loc:true, tolerant:true, comment:true });
    return { ...file, ast, error:null };
  } catch (e) {
    return { ...file, ast:null, error:String(e && e.message || e) };
  }
}

const DECISION_NODES = new Set([
  "IfStatement","ForStatement","ForInStatement","ForOfStatement","WhileStatement","DoWhileStatement",
  "SwitchCase","CatchClause","ConditionalExpression"
]);

function walk(node, enter, parent=null) {
  if (!node || typeof node !== "object") return;
  enter && enter(node, parent);
  for (const key in node) {
    if (!node.hasOwnProperty(key)) continue;
    const val = node[key];
    if (val && typeof val === "object") {
      if (Array.isArray(val)) for (const c of val) walk(c, enter, node);
      else walk(val, enter, node);
    }
  }
}

function functionName(node, parent) {
  if (node.type === "FunctionDeclaration" && node.id) return node.id.name;
  if ((node.type === "FunctionExpression" || node.type === "ArrowFunctionExpression")) {
    // try to infer from variable assignment
    if (parent && parent.type === "VariableDeclarator" && parent.id && parent.id.name) return parent.id.name;
    if (parent && parent.type === "Property" && parent.key) return parent.key.name || (parent.key.value ?? "anonymous");
  }
  return "(anonymous)";
}

function linesOf(node) {
  if (!node.loc) return 0;
  return node.loc.end.line - node.loc.start.line + 1;
}

function computeCC(fnNode) {
  let cc = 1; // baseline
  walk(fnNode.body || fnNode, (n, p) => {
    if (DECISION_NODES.has(n.type)) {
      if (n.type === "SwitchCase" && n.test === null) return; // default doesn't add
      cc += 1;
    }
    if (n.type === "LogicalExpression" && (n.operator === "&&" || n.operator === "||")) cc += 1;
  }, fnNode);
  return cc;
}

function computeMaxNesting(fnNode) {
  let depth = 0, maxDepth = 0;
  const incIf = new Set(["IfStatement","ForStatement","ForInStatement","ForOfStatement","WhileStatement","DoWhileStatement","SwitchStatement","TryStatement"]);
  walk(fnNode.body || fnNode, (n, p) => {
    if (incIf.has(n.type)) { depth++; maxDepth = Math.max(maxDepth, depth); }
    // on leave is harder in this simple walker — approximate by decreasing when hitting block ends
    if (n.type === "BlockStatement") { /* no-op; keeping simple */ }
  }, fnNode);
  return maxDepth; // rough approximation
}

function extractDependencies(ast) {
  const deps = [];
  walk(ast, (n, p) => {
    if (n.type === "ImportDeclaration" && n.source && n.source.value) deps.push(n.source.value);
    if (n.type === "CallExpression" && n.callee && n.callee.name === "require" && n.arguments && n.arguments[0] && n.arguments[0].value) {
      deps.push(n.arguments[0].value);
    }
  });
  return deps;
}

function analyzeFiles(files) {
  const parsed = files.map(parseFile);
  const errors = parsed.filter(f => f.error).map(f => `❌ ${f.name}: ${f.error}`);
  const moduleIndex = new Map(parsed.map(f => [norm(f.name), f]));

  const functions = [];
  const edges = []; // {from,to}
  const extModules = new Set();

  for (const f of parsed) {
    if (!f.ast) continue;
    // functions
    walk(f.ast, (n, p) => {
      if (n.type === "FunctionDeclaration" || n.type === "FunctionExpression" || n.type === "ArrowFunctionExpression") {
        const name = functionName(n, p);
        const loc = linesOf(n);
        const params = (n.params || []).length;
        const cc = computeCC(n);
        const nesting = computeMaxNesting(n);
        const notes = [];
        if (cc >= 10) notes.push("High CC");
        else if (cc >= 5) notes.push("Medium CC");
        if (loc >= 60) notes.push("Long");
        if (nesting >= 4) notes.push("Deep Nesting");
        functions.push({ file:f.name, name, loc, params, cc, nesting, notes });
      }
    });

    // deps
    const deps = extractDependencies(f.ast);
    const from = norm(f.name);
    for (const raw of deps) {
      if (!raw) continue;
      const cleaned = norm(raw);
      const isLocal = cleaned.startsWith('.') || cleaned.includes('/');
      if (isLocal) {
        // Try to map to a project file by normalized name
        const target = moduleIndex.get(cleaned) || moduleIndex.get(norm(cleaned + ".js")) || moduleIndex.get(norm(cleaned + "/index.js"));
        if (target) edges.push({ from, to: norm(target.name) });
        else { edges.push({ from, to: cleaned }); extModules.add(cleaned); } // unresolved relative
      } else {
        edges.push({ from, to: cleaned }); extModules.add(cleaned);
      }
    }
  }

  // stats
  const totalFuncs = functions.length;
  const maxCC = totalFuncs ? Math.max(...functions.map(f => f.cc)) : 0;
  const avgCC = totalFuncs ? (functions.reduce((a,b) => a + b.cc, 0) / totalFuncs) : 0;
  // goofy but effective mock score
  const longPct = totalFuncs ? (functions.filter(f => f.loc > 40).length / totalFuncs) * 100 : 0;
  const score = Math.max(0, Math.round(100 - avgCC*6 - longPct*0.4 - errors.length*8));

  return { parsed, functions, edges, extModules: [...extModules], stats: { files: parsed.length, totalFuncs, maxCC, avgCC, score }, errors };
}

/* ---------- Renderers ---------- */
function renderSummary(stats, errors) {
  $("#s_files").textContent = stats.files;
  $("#s_funcs").textContent = stats.totalFuncs;
  $("#s_avgcc").textContent = stats.avgCC ? stats.avgCC.toFixed(1) : "0.0";
  $("#s_maxcc").textContent = stats.maxCC;
  const grade = $("#grade");
  grade.textContent = `Score: ${stats.score}`;
  grade.className = "pill " + (stats.score >= 80 ? "" : stats.score >= 60 ? "warn" : "bad");
  const errBox = $("#errors");
  errBox.innerHTML = "";
  for (const e of errors) errBox.append(el("div", { class:"small error" }, e));
}

function renderFnTable(functions) {
  const tbody = $("#fnTable tbody");
  tbody.innerHTML = "";
  const sorted = functions.slice().sort((a,b) => b.cc - a.cc || b.loc - a.loc).slice(0, 50);
  for (const fn of sorted) {
    const tr = el("tr");
    tr.append(
      el("td", {}, el("span", { class:"mono" }, fn.name)),
      el("td", {}, el("span", { class:"small" }, fn.file)),
      el("td", {}, String(fn.loc)),
      el("td", {}, String(fn.params)),
      el("td", {}, el("span", { class: "pill " + (fn.cc>=10?"bad":fn.cc>=5?"warn":"") }, String(fn.cc))),
      el("td", {}, fn.notes.join(", "))
    );
    tbody.appendChild(tr);
  }
}

function renderASTList(parsed) {
  const sel = $("#astSelect");
  sel.innerHTML = "";
  for (const f of parsed) {
    const opt = el("option", { value:f.name }, f.name + (f.error ? " (parse error)" : ""));
    sel.appendChild(opt);
  }
  sel.onchange = () => showAST(parsed.find(p => p.name === sel.value));
  if (parsed[0]) { sel.value = parsed[0].name; showAST(parsed[0]); }
}

function trimAST(node, depth=0, maxDepth=3) {
  if (!node || typeof node !== "object") return node;
  if (depth >= maxDepth) return { type: node.type };
  const out = { type: node.type };
  if (node.loc) out.loc = { start: node.loc.start, end: node.loc.end };
  for (const k of Object.keys(node)) {
    const v = node[k];
    if (k === "type" || k === "loc" || k === "range") continue;
    if (Array.isArray(v)) out[k] = v.slice(0, 4).map(c => trimAST(c, depth+1, maxDepth));
    else if (v && typeof v === "object") out[k] = trimAST(v, depth+1, maxDepth);
    else if (typeof v !== "function") out[k] = v;
  }
  return out;
}
function showAST(file) {
  const out = $("#astOut");
  if (!file) { out.textContent = ""; return; }
  if (file.error) { out.textContent = "Parse error: " + file.error; return; }
  const trimmed = trimAST(file.ast);
  out.textContent = JSON.stringify(trimmed, null, 2);
}

function renderGraph(edges, parsed, extModules) {
  const svg = d3.select("#graph");
  svg.selectAll("*").remove();
  const width = svg.node().clientWidth, height = +svg.attr("height");

  const projectFiles = new Set(parsed.map(p => norm(p.name)));
  const nodesMap = new Map();
  function addNode(id, isExternal) {
    if (!nodesMap.has(id)) nodesMap.set(id, { id, external: isExternal });
  }

  edges.forEach(e => {
    addNode(e.from, false);
    const isExt = !projectFiles.has(norm(e.to));
    addNode(e.to, isExt);
  });

  const nodes = Array.from(nodesMap.values());
  const links = edges.map(e => ({ source: e.from, target: e.to }));

  const sim = d3.forceSimulation(nodes)
    .force("link", d3.forceLink(links).id(d => d.id).distance(80).strength(0.6))
    .force("charge", d3.forceManyBody().strength(-220))
    .force("center", d3.forceCenter(width/2, height/2))
    .force("collision", d3.forceCollide().radius(40));

  const link = svg.append("g")
    .attr("stroke", "#3653a3")
    .attr("stroke-opacity", 0.7)
    .selectAll("line")
    .data(links)
    .enter().append("line")
    .attr("stroke-width", 1.2);

  const node = svg.append("g")
    .selectAll("g")
    .data(nodes)
    .enter().append("g")
    .call(d3.drag()
      .on("start", (event, d) => { if (!event.active) sim.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; })
      .on("drag", (event, d) => { d.fx = event.x; d.fy = event.y; })
      .on("end",  (event, d) => { if (!event.active) sim.alphaTarget(0); d.fx = null; d.fy = null; }));

  node.append("rect")
    .attr("x", -45).attr("y", -14).attr("rx", 6).attr("ry", 6)
    .attr("width", 90).attr("height", 28)
    .attr("fill", d => d.external ? "#134d3a" : "#1a2c6a")
    .attr("stroke", d => d.external ? "#2b8c6b" : "#2b3c7b");

  node.append("text")
    .attr("text-anchor", "middle")
    .attr("dy", "0.35em")
    .attr("font-size", 11)
    .attr("fill", "#dbe6ff")
    .text(d => d.id.length > 18 ? d.id.slice(0,17) + "…" : d.id);

  sim.on("tick", () => {
    link
      .attr("x1", d => d.source.x).attr("y1", d => d.source.y)
      .attr("x2", d => d.target.x).attr("y2", d => d.target.y);
    node.attr("transform", d => `translate(${d.x},${d.y})`);
  });
}

/* ---------- Orchestrate ---------- */
$("#analyze").onclick = () => {
  const files = getFiles();
  const result = analyzeFiles(files);
  renderSummary(result.stats, result.errors);
  renderFnTable(result.functions);
  renderGraph(result.edges, result.parsed, result.extModules);
  renderASTList(result.parsed);
};

/* ---------- Boot with examples ---------- */
addFileUI("main.js", exampleMain);
addFileUI("utils.js", exampleUtils);
</script>
</body>
</html>
